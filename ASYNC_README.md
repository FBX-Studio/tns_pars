# Асинхронная система мониторинга

## Что изменилось

Система мониторинга переписана на асинхронную архитектуру для решения проблемы зависания при запуске.

## Преимущества асинхронного парсинга

1. **Параллельный сбор** - все источники (VK, Telegram, Новости) обрабатываются одновременно
2. **Нет зависаний** - веб-интерфейс не блокируется во время сбора
3. **Быстрее** - сбор данных происходит в 3 раза быстрее
4. **Надежнее** - ошибка в одном источнике не останавливает другие

## Файлы

- `async_monitor.py` - новая асинхронная система мониторинга
- `monitor.py` - старая синхронная версия (оставлена для совместимости)
- `run_collection_async.py` - скрипт для однократного асинхронного сбора

## Как запускать

### Вариант 1: Полная система (веб + мониторинг)

```bash
python run.py
```

Запускает:
- Веб-интерфейс на http://localhost:5000
- Асинхронный мониторинг в фоне (автоматический сбор каждые N минут)

### Вариант 2: Только веб-интерфейс

```bash
python app.py
```

Можно запускать сбор вручную через кнопку в веб-интерфейсе.

### Вариант 3: Однократный сбор

```bash
python run_collection_async.py
```

Выполняет один асинхронный сбор из всех источников и завершается.

### Вариант 4: Только асинхронный мониторинг

```bash
python async_monitor.py
```

Запускает планировщик с автоматическим сбором каждые N минут (без веб-интерфейса).

## Как работает

### Асинхронный сбор

```python
# Все источники запускаются параллельно
tasks = [
    collect_from_source_async('vk', vk_collector),
    collect_from_source_async('telegram', telegram_collector),
    collect_from_source_async('news', news_collector),
]

# asyncio.gather выполняет все задачи одновременно
results = await asyncio.gather(*tasks)
```

### Результаты в логах

```
============================================================
ЗАПУСК ЦИКЛА МОНИТОРИНГА (АСИНХРОННЫЙ РЕЖИМ)
============================================================
[vk] Начало сбора данных...
[telegram] Начало сбора данных...
[news] Начало сбора данных...
[vk] ✓ Завершено: собрано 5 новых отзывов
[telegram] ✓ Завершено: собрано 3 новых отзыва
[news] ✓ Завершено: собрано 12 новых отзывов
============================================================
РЕЗУЛЬТАТЫ МОНИТОРИНГА:
✓ VK: 5 отзывов
✓ TELEGRAM: 3 отзыва
✓ NEWS: 12 отзывов
ВСЕГО СОБРАНО: 20 новых отзывов
============================================================
```

## Веб-интерфейс

При запуске через кнопку "▶ Запустить сбор вручную" в веб-интерфейсе:

1. Сбор запускается в отдельном потоке (не блокирует веб)
2. Все источники обрабатываются параллельно
3. Прогресс можно видеть в логах
4. Страница не зависает

## Настройки

В файле `.env`:

```env
# Интервал автоматического мониторинга (в минутах)
MONITORING_INTERVAL_MINUTES=30

# Ключевые слова для поиска
COMPANY_KEYWORDS=ТНС энерго НН,ТНС энерго,электросети,ТНС,энс
```

## Устранение проблем

### Если всё равно зависает

1. Проверьте, что используется `async_monitor.py`, а не `monitor.py`
2. Проверьте логи на наличие ошибок
3. Попробуйте запустить только веб: `python app.py`
4. Запустите сбор отдельно: `python run_collection_async.py`

### Если нужна старая версия

Измените в `run.py`:

```python
# Вместо
monitor_process = subprocess.Popen([sys.executable, 'async_monitor.py'], ...)

# Используйте
monitor_process = subprocess.Popen([sys.executable, 'monitor.py'], ...)
```

И в `app.py`:

```python
# Вместо
from async_monitor import AsyncReviewMonitor

# Используйте
from monitor import ReviewMonitor
```

## Требования

Все необходимые библиотеки уже есть в `requirements.txt`. Асинхронность работает на встроенном `asyncio`, дополнительные библиотеки не нужны.
