{% extends "base.html" %}

{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - –¢–ù–° —ç–Ω–µ—Ä–≥–æ –ù–ù{% endblock %}

{% block content %}
<h2 style="margin-bottom: 2rem;">üì° –ñ—É—Ä–Ω–∞–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h2>

<div class="card">
    <h3 style="margin-bottom: 1rem;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                <th>–ù–∞—á–∞–ª–æ</th>
                <th>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°–æ–±—Ä–∞–Ω–æ</th>
                <th>–û—à–∏–±–∫–∞</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.id }}</td>
                <td><strong>{{ log.source.upper() }}</strong></td>
                <td>{{ log.started_at.strftime('%d.%m.%Y %H:%M:%S') if log.started_at else '-' }}</td>
                <td>{{ log.completed_at.strftime('%d.%m.%Y %H:%M:%S') if log.completed_at else '-' }}</td>
                <td>
                    {% if log.status == 'success' %}
                        <span class="badge badge-approved">–£—Å–ø–µ—à–Ω–æ</span>
                    {% elif log.status == 'error' %}
                        <span class="badge badge-rejected">–û—à–∏–±–∫–∞</span>
                    {% elif log.status == 'running' %}
                        <span class="badge badge-pending">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è</span>
                    {% else %}
                        <span class="badge badge-neutral">{{ log.status }}</span>
                    {% endif %}
                </td>
                <td>{{ log.reviews_collected }}</td>
                <td>{{ log.error_message or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h3>
    <p><strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏:</strong> –∫–∞–∂–¥—ã–µ {{ config.MONITORING_INTERVAL_MINUTES }} –º–∏–Ω—É—Ç</p>
    <p><strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong> {{ config.COMPANY_KEYWORDS|join(', ') }}</p>
    <div style="margin-top: 1rem;">
        <button onclick="startMonitoring()" class="btn btn-primary">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –≤—Ä—É—á–Ω—É—é</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function startMonitoring() {
    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤?')) {
        return;
    }
    
    const button = event.target;
    button.disabled = true;
    button.textContent = '‚è≥ –ó–∞–ø—É—Å–∫...';
    
    fetch('/api/monitoring/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì ' + data.message);
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('‚úó ' + data.message);
            button.disabled = false;
            button.textContent = '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –≤—Ä—É—á–Ω—É—é';
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error);
        button.disabled = false;
        button.textContent = '‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä –≤—Ä—É—á–Ω—É—é';
    });
}
</script>
{% endblock %}
