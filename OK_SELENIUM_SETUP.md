# 🚀 Selenium коллектор для OK.ru - Инструкция

## ✅ Что реализовано

**Проблема:** OK.ru блокирует все автоматические запросы (возвращает 0 байт)

**Решение:** Полноценный браузер через Selenium + автоматические бесплатные прокси

---

## 📋 Быстрый старт

### 1. Откройте приложение

```
http://127.0.0.1:5001
```

### 2. Запустите сбор

1. Перейдите в **🔄 Мониторинг**
2. Выберите период (например, "За последний день")
3. Нажмите **"Запустить сбор"**
4. Смотрите логи в реальном времени

### 3. Что увидите в логах

```
[MONITOR] ✓ Используется OK Selenium коллектор (ПРИОРИТЕТ)
[OK-Selenium] ================================================
[OK-Selenium] ЗАПУСК SELENIUM КОЛЛЕКТОРА ДЛЯ OK.RU
[OK-Selenium] ================================================

[OK-Selenium] Попытка 1: БЕЗ прокси
[OK-Selenium] ✓ Chrome драйвер успешно инициализирован
[OK-Selenium] Запуск поиска: ТНС энерго НН
[OK-Selenium] Открываю: https://ok.ru/search?st.query=...
[OK-Selenium] Всего найдено элементов: 15
[OK-Selenium] ✓ Найден пост: ТНС Энерго НН ответила на...
[OK-Selenium] ✓ Найден пост: Обращение в ТНС было рассмотрено...
[OK-Selenium] ✓✓✓ УСПЕХ! Собрано 3 постов
[OK-Selenium] Скриншот сохранен: ok_selenium_screenshot.png
```

### 4. Просмотр результатов

1. Перейдите в **💬 Отзывы**
2. Фильтр → Источник → **ok**
3. Увидите найденные посты

---

## ⚙️ Как работает

### Алгоритм работы

```
┌─────────────────────────────────────┐
│   Попытка 1: БЕЗ прокси             │
├─────────────────────────────────────┤
│ 1. Запуск Chrome (headless)         │
│ 2. Открытие ok.ru/search            │
│ 3. Ожидание загрузки (3-5 сек)     │
│ 4. Скроллинг страницы               │
│ 5. Парсинг результатов              │
│ 6. Создание скриншота               │
└─────────────────────────────────────┘
           │
           ↓ (если 0 постов)
┌─────────────────────────────────────┐
│   Попытка 2: С ПРОКСИ               │
├─────────────────────────────────────┤
│ 1. Загрузка списка прокси           │
│    - geonode.com                    │
│    - proxy-list.download            │
│ 2. Попытка с прокси #1              │
│    └─ Не работает? → прокси #2      │
│ 3. Попытка с прокси #2              │
│    └─ Не работает? → прокси #3      │
│ 4. Попытка с прокси #3              │
└─────────────────────────────────────┘
           │
           ↓ (результат)
┌─────────────────────────────────────┐
│   ✓ Найдено N постов                │
│   или                               │
│   ⚠ Посты не найдены               │
│   (нужен Tor или платные прокси)    │
└─────────────────────────────────────┘
```

### Технологии

- **Selenium WebDriver** - автоматизация браузера
- **Chrome Headless** - невидимый браузер
- **webdriver-manager** - автоматическая установка ChromeDriver
- **BeautifulSoup** - парсинг HTML
- **Обход детекции ботов** - скрытие признаков Selenium

---

## ⚠️ Возможные проблемы и решения

### Проблема 1: Первый запуск медленный (~30 секунд)

**Причина:** Загрузка ChromeDriver

**Решение:** Подождите, это происходит только один раз

**Логи:**
```
[OK-Selenium] ✓ Chrome драйвер успешно инициализирован
```

---

### Проблема 2: Капча на OK.ru

**Признаки:**
```
[OK-Selenium] ⚠ Обнаружена капча! Пробую подождать...
[OK-Selenium] Попытка 2: С БЕСПЛАТНЫМИ ПРОКСИ
```

**Решение 1: Настройте Tor Browser**

1. Скачайте Tor: https://www.torproject.org/
2. Запустите Tor Browser
3. Откройте **⚙️ Настройки → Прокси и Tor**
4. Включите:
   ```
   USE_TOR=True
   TOR_PORT=9150
   ```

**Решение 2: Используйте платные прокси**

1. Купите SOCKS5 прокси (например, на proxy-seller.com)
2. Откройте **⚙️ Настройки → Прокси**
3. Укажите:
   ```
   SOCKS_PROXY=socks5://user:pass@host:port
   ```

**Решение 3: Получите API OK.ru**

1. Зарегистрируйте приложение: https://ok.ru/dk
2. Получите токен доступа
3. Добавьте в `.env`:
   ```
   OK_ACCESS_TOKEN=ваш_токен
   OK_APP_KEY=ваш_ключ
   ```

---

### Проблема 3: Постов не найдено (0 постов)

**Возможные причины:**

1. **OK.ru блокирует ваш IP**
   - Решение: используйте прокси/VPN/Tor

2. **По вашим ключевым словам нет постов**
   - Проверьте вручную: https://ok.ru/search?st.query=ТНС+энерго+НН
   - Измените ключевые слова в **⚙️ Настройки → Ключевые слова**

3. **Все бесплатные прокси заблокированы**
   - Бесплатные прокси часто не работают
   - Используйте платные прокси или Tor

**Логи при блокировке:**
```
[OK-Selenium] ПОСТОВ НЕ НАЙДЕНО
[OK-Selenium] Возможные причины:
[OK-Selenium] 1. OK.ru показывает капчу
[OK-Selenium] 2. Все прокси заблокированы
[OK-Selenium] 3. На странице нет постов по вашим ключевым словам
```

---

### Проблема 4: Ошибка "Chrome driver not found"

**Причина:** Не установлен Chrome или ChromeDriver

**Решение:** Установите Chrome:
- Windows: https://www.google.com/chrome/
- ChromeDriver загрузится автоматически

---

## 🔍 Отладка

### Скриншоты для проверки

После каждого запуска создается скриншот:
```
E:\work\tns_pars\ok_selenium_screenshot.png
```

Откройте его чтобы увидеть что именно видит браузер.

### Диагностический скрипт

Запустите для проверки:
```bash
cd E:\work\tns_pars
python test_ok_parsing.py
```

Откроет 3 файла:
- `ok_search_response.html` - десктопная версия (обычно пустая)
- `ok_group_response.html` - группа (обычно требует авторизацию)
- `ok_mobile_response.html` - мобильная версия (может работать)

### Подробные логи

Чтобы увидеть больше деталей:
1. Откройте `collectors/ok_selenium_collector.py`
2. Найдите строку: `chrome_options.add_argument('--headless=new')`
3. Закомментируйте её: `# chrome_options.add_argument('--headless=new')`
4. Перезапустите сервер

Теперь браузер откроется видимым и вы увидите что происходит!

---

## 📊 Статистика

### Что собирается:

- **Источник:** ok.ru
- **Поиск:** По ключевым словам (ТНС энерго, ТНС НН и т.д.)
- **Фильтрация:** Исключаются нерелевантные (Газпром, Т Плюс, вакансии)
- **Анализ:** Автоматический анализ тональности
- **Сохранение:** В базу данных SQLite

### Производительность:

- **Без прокси:** 5-10 секунд на запрос
- **С прокси:** 15-30 секунд (проверка нескольких прокси)
- **Первый запуск:** +30 секунд (загрузка ChromeDriver)

---

## 🎯 Рекомендации

### Для лучших результатов:

1. ✅ **Используйте Tor** - самый надежный способ
2. ✅ **Увеличьте задержки** - меньше вероятность блокировки
3. ✅ **Запускайте реже** - не чаще 1 раза в час
4. ✅ **Проверяйте скриншоты** - видите что видит бот
5. ✅ **Настройте ключевые слова** - точнее результаты

### НЕ делайте:

1. ❌ Не запускайте сбор каждую минуту
2. ❌ Не используйте без прокси если видите капчу
3. ❌ Не отключайте задержки (random_delay)
4. ❌ Не ждите 100% результат - OK.ru очень защищен

---

## 📝 Изменённые файлы

- ✅ `collectors/ok_selenium_collector.py` - **НОВЫЙ** Selenium коллектор
- ✅ `collectors/ok_collector_working.py` - **НОВЫЙ** мультиметод коллектор
- ✅ `async_monitor_websocket.py` - приоритет Selenium коллектора
- ✅ `test_ok_parsing.py` - **НОВЫЙ** диагностический скрипт
- ✅ `ИЗМЕНЕНИЯ.md` - подробная документация
- ✅ `OK_SELENIUM_SETUP.md` - этот файл (инструкция)

---

## ❓ FAQ

**Q: Нужно ли что-то устанавливать дополнительно?**
A: Нет, если Chrome уже установлен. ChromeDriver загрузится автоматически.

**Q: Работает ли на Linux/Mac?**
A: Да, Selenium работает на всех платформах.

**Q: Можно ли парсить без прокси?**
A: Можно попробовать, но OK.ru скорее всего заблокирует.

**Q: Сколько постов можно собрать?**
A: Зависит от OK.ru и ваших ключевых слов. Обычно 3-10 постов за раз.

**Q: Почему так медленно?**
A: Selenium запускает реальный браузер - это медленнее чем HTTP запросы, но надежнее.

**Q: Можно ли увеличить скорость?**
A: Да, уменьшите задержки в коде, но риск блокировки выше.

---

## 🎉 Готово!

Selenium коллектор настроен и готов к работе! 🚀

**Запустите сбор:** http://127.0.0.1:5001 → 🔄 Мониторинг → Запустить сбор

Удачи! 💪
